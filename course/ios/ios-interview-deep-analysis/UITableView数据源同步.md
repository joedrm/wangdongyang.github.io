## UITabelView 数据源同步问题

在实际的开发过程当中，比如说新闻资讯类的APP，用 `UITableVIew` 来显示新闻数据，实际的场景呢，比如在新闻列表中插入的一条广告，当我们把它插掉时就涉及到删除操作。之后可能又会触发一个 `load more` 操作后向刷新来加载更多数据。

此时的删除操作在主线程当中，因为是这个用户的一个交互动作，而 `load more` 操作在子线程发送网络请求。那这就涉及到了多线程对共享数据的访问，如何解决这种 `table view` 在多线程环境下去修改或者说访问它的数据源？

关于数据源同步有两种解决方案。

### 并发访问数据拷贝

![-min.png](https://s2.loli.net/2025/04/17/BnAfo5rqDNRmshx.png)

如上图所示，通常将主线程的数据拷贝给子线程，在子线程当中进行新数据的网络请求。包括数据解析以及预排版等内容。此时假如在子线程进行网络请求，或者正在数据解析的过程当中，而我们在主线程当中删除了一行数据。在主线程 `reload UI` 之后，这条数据不见了，接着主线程去做其它的任务（`other work`）。子线程此时返回这个请求的结果，然后又重新 `reload` 一下这个主线程。子线程使用的是曾经主线程当中的一个数据拷贝，而它拷贝的时机是在删除这一行数据之前。也就是说，子线程当中返回给主线程的数据源列表当中仍然包含删除之前的这行数据。

之前删除的数据又重新出现了，那这个就是出现数据源的同步问题，解决办法就是我们可以在这个主线程当中进行删除操作的时候把它记录下来之后呢，在子线程将要返回数据去更新主线程UI的时候，把拷贝过来的数据也做一次删除操作。然后再回到主线程去 `reload UI` 就可以保证数据源是同步的。

### 串行访问

在子线程进行网络请求和数据解析，然后将返回的数据放在串行队列新增数据的预排版，此时还是在子线程当中。在这个过程中，如果主线程中删除一行数据，需要以同步的方式去在串行队列当中去进行处理。这个过程当中，如果说子线程正在这个串行队列当中去进行新增数据预排版等操作的时候？主线程则需要等待一小会儿，然后在这个串行队列前一个block任务执行完成之后，再去同步主线程发送过来的删除操作，最后再回到主线程更新 UI。保证我们不论是在主线程还是子线程。对于`TableView` 的数据源的操作，都是在串行队列上面去进行的，也就保证了数据源的一个同步的问题。

![-min.png](https://s2.loli.net/2025/04/17/XiEAUenMdzb9qOj.png)

### 总结

并发访问数据拷贝: 适用于需要高性能且能接受一定内存开销的场景。
串行访问: 适用于对数据源同步要求严格且能接受一定延时的场景。
选择依据: 在具体场景中，应根据实际业务需求和性能要求选择合适的方案。